@layout Patient.Api.Client.Layout.UserLayout

@rendermode @(new InteractiveServerRenderMode(false))

@using Patient.Domain.Interfaces
@using Patient.Domain.Entities.DTOs
@using Patient.Domain.Entities
@using Patient.Domain.Constants

@inject IPatientApiService _patientApiService
@inject IBlobStorageService _blobStorageService

@page "/pacjent/raporty/{Id}"


<div class="container px-4">
    <div class="row pt-5">
        <div class="justify-content-start align-content-start">
            <NavLink href="/pacjent/raporty">
                <btn type="button" class="back-icon bi-arrow-left"></btn>
            </NavLink>
        </div>
        <div class="col">
        </div>
        <div class="col-8 report text-center ">
            <div class="row  text-center border-1 border-bottom border-dark text-center">
                <h2>Raport</h2>
                <p>Data: @reportToShow.DateOfCreating</p>
            </div>
            <div class="row text-center min-height-10 border-1 border-bottom border-dark">
                <h4>Opis:</h4>
                <p>@reportToShow.Description</p>
            </div>
            <div class="row  text-center min-height-7">
                <div class="col border-right">
                    <h4>Pliki:</h4>
                    @if(reportToShow.FileNames.Count() > 0)
                    {
                        for(int i=0;i<reportToShow.FileNames.Count();i++)
                        {
                            <div class="file-block mx-2" @onclick="() => HandleShowFile(i)">
                                <div class="bi-x-circle"></div>
                                <div class="bi-file-icon"></div>
                                @* <p>@reportToShow.FileNames.ElementAt(i)</p> *@
                            </div>
                        }
                    }
                </div>
                <div class="col">
                    <div class="row d-flex-column border-1 border-bottom border-dark">
                        <p>Lekarze sprawdzajacy:</p>
                        <p>Lekarz</p>

                    </div>
                    <div class="row">
                        <div class="col">
                            @reportToShow.IsChecked
                        </div>
                        <div class="col">
                            Rekomendacja
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
        </div>
    </div>
</div>

@code {

    [Parameter]
    public string Id { get; set; }

    private ReportToShowDto reportToShow = new();
    private bool fileGet;
    private bool readingReport;

    private bool showPreviewModal;


    protected async override Task OnInitializedAsync()
    {
        readingReport = true;
        var response = await _patientApiService.SendRequestGetReport(Id);
        if (response.StatusCode == System.Net.HttpStatusCode.OK)
        {
            reportToShow = await response.Content.ReadFromJsonAsync<ReportToShowDto>();
            if (reportToShow.FileNames.Any())
            {
                foreach (var filename in reportToShow.FileNames)
                {
                    var url = await _blobStorageService.GetBlobSasUrl(filename, BlobContainerNames.ReportsFiles);
                    reportToShow.FilesBase64.Add(await LoadImageBase64(url));
                }
            }
            
        }
        
        StateHasChanged();
        readingReport = false;

    }

    private async void HandleShowFile(int positionOnTheList)
    {
        // medicalFileToShowPreview = file;
        // showPreviewModal = true;
        // loadingDocument = true;
        // medicalFileToShowPreview.FileBase64 = await LoadImageBase64(medicalFileToShowPreview.FileUrl);
        // loadingDocument = false;
        // StateHasChanged();
    }

    private async Task<string> LoadImageBase64(string url)
    {
        using (var _httpClient = new HttpClient())
        {
            var response = await _httpClient.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var imageBytes = await response.Content.ReadAsByteArrayAsync();
                return $"data:image/jpeg;base64,{Convert.ToBase64String(imageBytes)}";

            };
            return null;
        }

    }

}
